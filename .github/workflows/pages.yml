# Deploy to GitHub Pages
# Purpose: build the site, package the build output as an artifact, then deploy to Pages.

name: Deploy to GitHub Pages

on:
  # Deploy automatically when main and develop changes.
  push:
    branches: [ main ]

  # Allow manual deploys (optionally deploy a specific ref).
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch, tag, or SHA). Leave empty for default."
        required: false
        default: ""

# Least privilege permissions for this workflow.
permissions:
  contents: read   # Required for checkout.
  pages: write     # Required to publish to Pages.
  id-token: write  # Required by the Pages deploy action.
  actions: read    # Required for artifact handling in some setups.

# Prevent overlapping deploys.
concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    # Build job: install → test → build → upload artifact.
    runs-on: ubuntu-latest

    outputs:
      # Expose Pages base path in case other jobs need it.
      base_path: ${{ steps.configure-pages.outputs.base_path }}

    steps:
      # Pull the repo onto the runner.
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # If workflow_dispatch input is set, deploy that ref; otherwise deploy the current ref.
          ref: ${{ inputs.ref || github.ref }}

      # Determine the correct base path for GitHub Pages project sites.
      - name: Configure Pages
        id: configure-pages
        uses: actions/configure-pages@v5

      # Install Node and enable npm caching (npm download cache).
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: site/package-lock.json

      # Install dependencies from package-lock.json (reproducible installs).
      - name: Install dependencies
        working-directory: site
        run: npm ci

      # Run the test suite (CI gate).
      - name: Run tests
        working-directory: site
        run: npm test

      # Set build metadata for the frontend.
      - name: Set build metadata
        run: |
          echo "VITE_COMMIT_SHA=${GITHUB_SHA}" >> "$GITHUB_ENV"
          echo "VITE_BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"
          echo "VITE_REF_NAME=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          echo "VITE_REPO=${GITHUB_REPOSITORY}" >> "$GITHUB_ENV"
          echo "VITE_ACTOR=${GITHUB_ACTOR}" >> "$GITHUB_ENV"
          echo "VITE_EVENT_NAME=${GITHUB_EVENT_NAME}" >> "$GITHUB_ENV"
          echo "VITE_WORKFLOW=${GITHUB_WORKFLOW}" >> "$GITHUB_ENV"
          echo "VITE_RUN_NUMBER=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"
          echo "VITE_RUN_ATTEMPT=${GITHUB_RUN_ATTEMPT}" >> "$GITHUB_ENV"
          echo "VITE_SERVER_URL=${GITHUB_SERVER_URL}" >> "$GITHUB_ENV"
          echo "VITE_RUN_URL=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> "$GITHUB_ENV"
          echo "VITE_CI_WORKFLOW_FILE=ci.yml" >> "$GITHUB_ENV"
          echo "VITE_PAGES_WORKFLOW_FILE=pages.yml" >> "$GITHUB_ENV"

      # Build the project and inject build metadata into the frontend.
      - name: Build
        working-directory: site
        env:
          # Use the correct base path for GitHub Pages project sites.
          BASE_PATH: ${{ steps.configure-pages.outputs.base_path }}
        run: npm run build

      # Package build output for the deploy job.
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/dist

  deploy:
    # Deploy job: publish the artifact to GitHub Pages.
    runs-on: ubuntu-latest
    needs: build

    # Tie the deployment to the github-pages environment (supports approvals/protection rules).
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      # Deploy the uploaded artifact to GitHub Pages.
      - name: Deploy
        id: deploy
        uses: actions/deploy-pages@v4
